<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05 - HandPose 基本</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #2d2d44; color: white; }
        canvas { border-radius: 10px; }
        #status { margin-top: 15px; padding: 10px; background: #3d3d5c; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>HandPose - 手の検出</h1>
    <p>手のキーポイント21点を検出します</p>

    <canvas id="canvas"></canvas>
    <div id="status">読み込み中...</div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');

        let video;
        let handPose;
        let hands = [];

        async function setup() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;
            canvas.width = 640;
            canvas.height = 480;

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();

            // HandPoseを初期化
            handPose = await ml5.handPose();
            status.textContent = '準備完了！手をカメラに向けてください';

            detectHands();
        }

        async function detectHands() {
            hands = await handPose.detect(video);
            draw();
            requestAnimationFrame(detectHands);
        }

        function draw() {
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            if (hands.length > 0) {
                status.textContent = `${hands.length}つの手を検出中`;

                for (let hand of hands) {
                    // 各キーポイントを描画
                    for (let i = 0; i < hand.keypoints.length; i++) {
                        const kp = hand.keypoints[i];
                        const x = canvas.width - kp.x;

                        // 指先は大きく、他は小さく
                        const isFingertip = [4, 8, 12, 16, 20].includes(i);
                        const radius = isFingertip ? 10 : 5;

                        ctx.beginPath();
                        ctx.arc(x, kp.y, radius, 0, 2 * Math.PI);
                        ctx.fillStyle = isFingertip ? '#ff6b6b' : '#4ecdc4';
                        ctx.fill();
                    }

                    // 指の骨を線で接続
                    const fingerConnections = [
                        [0, 1, 2, 3, 4],      // 親指
                        [0, 5, 6, 7, 8],      // 人差し指
                        [0, 9, 10, 11, 12],   // 中指
                        [0, 13, 14, 15, 16],  // 薬指
                        [0, 17, 18, 19, 20]   // 小指
                    ];

                    ctx.strokeStyle = '#ffe66d';
                    ctx.lineWidth = 2;

                    for (let finger of fingerConnections) {
                        ctx.beginPath();
                        for (let i = 0; i < finger.length; i++) {
                            const kp = hand.keypoints[finger[i]];
                            const x = canvas.width - kp.x;
                            if (i === 0) ctx.moveTo(x, kp.y);
                            else ctx.lineTo(x, kp.y);
                        }
                        ctx.stroke();
                    }
                }
            } else {
                status.textContent = '手を検出していません...';
            }
        }

        setup();
    </script>
</body>
</html>
