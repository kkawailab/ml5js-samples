<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10 - FaceMesh çµµæ–‡å­—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #1a1a2e; color: white; }
        canvas { border-radius: 15px; }
        .controls { margin: 20px 0; }
        .emoji-btn { font-size: 30px; padding: 10px 20px; margin: 5px; border: none; border-radius: 10px; cursor: pointer; background: #16213e; transition: all 0.3s; }
        .emoji-btn:hover { transform: scale(1.1); }
        .emoji-btn.active { background: #e94560; }
        #status { margin-top: 10px; color: #4ecca3; }
    </style>
</head>
<body>
    <h1>é¡”ã«çµµæ–‡å­—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h1>
    <p>çµµæ–‡å­—ã‚’é¸ã‚“ã§é¡”ã«è¡¨ç¤ºã—ã‚ˆã†</p>

    <div class="controls">
        <button class="emoji-btn active" data-emoji="ğŸ˜">ğŸ˜</button>
        <button class="emoji-btn" data-emoji="ğŸ¥³">ğŸ¥³</button>
        <button class="emoji-btn" data-emoji="ğŸ˜·">ğŸ˜·</button>
        <button class="emoji-btn" data-emoji="ğŸ¤–">ğŸ¤–</button>
        <button class="emoji-btn" data-emoji="ğŸ‘½">ğŸ‘½</button>
        <button class="emoji-btn" data-emoji="ğŸ¦Š">ğŸ¦Š</button>
    </div>

    <canvas id="canvas"></canvas>
    <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const emojiButtons = document.querySelectorAll('.emoji-btn');

        let video;
        let faceMesh;
        let faces = [];
        let currentEmoji = 'ğŸ˜';

        // çµµæ–‡å­—ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        emojiButtons.forEach(btn => {
            btn.onclick = () => {
                emojiButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentEmoji = btn.dataset.emoji;
            };
        });

        async function setup() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;
            canvas.width = 640;
            canvas.height = 480;

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();

            faceMesh = await ml5.faceMesh();
            status.textContent = 'æº–å‚™å®Œäº†ï¼';

            detectFaces();
        }

        async function detectFaces() {
            faces = await faceMesh.detect(video);
            draw();
            requestAnimationFrame(detectFaces);
        }

        function draw() {
            // ãƒ“ãƒ‡ã‚ªã‚’å·¦å³åè»¢ã—ã¦æç”»
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            if (faces.length > 0) {
                for (let face of faces) {
                    // é¡”ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                    const nose = face.keypoints[1]; // é¼»å…ˆ
                    const leftEye = face.keypoints[33];
                    const rightEye = face.keypoints[263];

                    if (nose && leftEye && rightEye) {
                        // é¡”ã®å¹…ã‚’è¨ˆç®—ï¼ˆç›®ã®é–“ã®è·é›¢ã‹ã‚‰æ¨å®šï¼‰
                        const eyeDistance = Math.abs(rightEye.x - leftEye.x);
                        const faceSize = eyeDistance * 3;

                        // å·¦å³åè»¢ã—ãŸåº§æ¨™
                        const x = canvas.width - nose.x;
                        const y = nose.y - faceSize * 0.3;

                        // çµµæ–‡å­—ã‚’æç”»
                        ctx.font = `${faceSize}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(currentEmoji, x, y);
                    }
                }
                status.textContent = `${faces.length}äººã®é¡”ã‚’æ¤œå‡º`;
            } else {
                status.textContent = 'é¡”ã‚’æ¤œå‡ºã—ã¦ã„ã¾ã›ã‚“...';
            }
        }

        setup();
    </script>
</body>
</html>
