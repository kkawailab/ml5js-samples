<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>28 - HandPose æŒ‡æ–‡å­—èªè­˜</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0d1117; color: white; text-align: center; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
        canvas { border-radius: 15px; width: 100%; }
        .panel { background: #161b22; padding: 20px; border-radius: 15px; text-align: left; }
        .panel h3 { margin-top: 0; color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .detected-letter { font-size: 120px; text-align: center; padding: 30px; background: #21262d; border-radius: 15px; margin-bottom: 20px; }
        .sentence { background: #21262d; padding: 20px; border-radius: 10px; min-height: 60px; font-size: 24px; margin-bottom: 20px; word-wrap: break-word; }
        .letter-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .letter-btn { padding: 15px; border: 2px solid #30363d; border-radius: 8px; background: transparent; color: white; cursor: pointer; font-size: 18px; transition: all 0.3s; }
        .letter-btn:hover { border-color: #58a6ff; }
        .letter-btn.detected { background: #238636; border-color: #238636; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .clear-btn { background: #f85149; color: white; flex: 1; }
        .space-btn { background: #21262d; color: white; flex: 1; }
        #status { color: #4ecca3; margin: 10px 0; }
        .instructions { background: #21262d; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; }
        .confidence { text-align: center; color: #8b949e; font-size: 14px; }
    </style>
</head>
<body>
    <h1>æŒ‡æ–‡å­—èªè­˜ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>æ‰‹ã®å½¢ã‹ã‚‰æŒ‡æ–‡å­—ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰ã‚’èªè­˜ã—ã¾ã™</p>

    <div class="container">
        <div>
            <canvas id="canvas" width="640" height="480"></canvas>
            <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div>
            <div class="detected-letter" id="detectedLetter">?</div>
            <div class="confidence" id="confidence">ç¢ºä¿¡åº¦: -</div>

            <div class="panel">
                <h3>èªè­˜ã—ãŸæ–‡</h3>
                <div class="sentence" id="sentence"></div>
                <div class="controls">
                    <button class="space-btn" onclick="addSpace()">ã‚¹ãƒšãƒ¼ã‚¹</button>
                    <button class="clear-btn" onclick="clearSentence()">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="panel">
                <h3>æŒ‡æ–‡å­—ã‚¬ã‚¤ãƒ‰</h3>
                <div class="instructions">
                    âœŠ ã‚°ãƒ¼ = A<br>
                    âœŒï¸ ãƒãƒ§ã‚­ = V<br>
                    âœ‹ ãƒ‘ãƒ¼ = B<br>
                    ğŸ‘† 1æœ¬æŒ‡ = D<br>
                    ğŸ¤Ÿ ILY = I Love You
                </div>
                <div class="letter-grid" id="letterGrid"></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const detectedLetter = document.getElementById('detectedLetter');
        const confidenceDiv = document.getElementById('confidence');
        const sentenceDiv = document.getElementById('sentence');
        const letterGrid = document.getElementById('letterGrid');
        const status = document.getElementById('status');

        let video;
        let handPose;
        let hands = [];
        let sentence = '';
        let lastLetter = null;
        let letterHoldTime = 0;
        let detectionHistory = [];

        // èªè­˜ã™ã‚‹æ–‡å­—
        const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'I', 'L', 'O', 'V', 'W', 'Y'];

        // ãƒ¬ã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
        letters.forEach(letter => {
            const btn = document.createElement('button');
            btn.className = 'letter-btn';
            btn.id = `letter-${letter}`;
            btn.textContent = letter;
            letterGrid.appendChild(btn);
        });

        async function setup() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();

            handPose = await ml5.handPose();
            status.textContent = 'æº–å‚™å®Œäº†ï¼æ‰‹ã‚’ã‹ã–ã—ã¦ãã ã•ã„';

            detectHands();
        }

        async function detectHands() {
            hands = await handPose.detect(video);
            const result = recognizeLetter();
            updateDisplay(result);
            draw();
            requestAnimationFrame(detectHands);
        }

        function isFingerExtended(hand, tipIdx, pipIdx) {
            const tip = hand.keypoints[tipIdx];
            const pip = hand.keypoints[pipIdx];
            return tip.y < pip.y - 15;
        }

        function isThumbExtended(hand) {
            const tip = hand.keypoints[4];
            const mcp = hand.keypoints[2];
            return Math.abs(tip.x - mcp.x) > 50;
        }

        function getFingerStates(hand) {
            return {
                thumb: isThumbExtended(hand),
                index: isFingerExtended(hand, 8, 6),
                middle: isFingerExtended(hand, 12, 10),
                ring: isFingerExtended(hand, 16, 14),
                pinky: isFingerExtended(hand, 20, 18)
            };
        }

        function recognizeLetter() {
            if (hands.length === 0) {
                return { letter: null, confidence: 0 };
            }

            const hand = hands[0];
            const fingers = getFingerStates(hand);
            const { thumb, index, middle, ring, pinky } = fingers;

            let letter = null;
            let confidence = 0.9;

            // æŒ‡æ–‡å­—ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
            if (!thumb && !index && !middle && !ring && !pinky) {
                letter = 'A'; // ã‚°ãƒ¼
            } else if (!thumb && index && middle && ring && pinky) {
                letter = 'B'; // 4æœ¬æŒ‡
            } else if (thumb && index && middle && ring && pinky) {
                letter = 'C'; // å…¨éƒ¨é–‹ãï¼ˆã‚«ãƒ¼ãƒ–ï¼‰
                confidence = 0.7;
            } else if (!thumb && index && !middle && !ring && !pinky) {
                letter = 'D'; // äººå·®ã—æŒ‡ã®ã¿
            } else if (!thumb && !index && !middle && !ring && !pinky) {
                letter = 'E';
                confidence = 0.6;
            } else if (!thumb && index && middle && ring && !pinky) {
                letter = 'F'; // 3æœ¬æŒ‡
                confidence = 0.7;
            } else if (thumb && !index && !middle && !ring && pinky) {
                letter = 'I'; // å°æŒ‡ã¨è¦ªæŒ‡
            } else if (thumb && index && !middle && !ring && !pinky) {
                letter = 'L'; // Lå­—
            } else if (thumb && index && middle && !ring && !pinky) {
                letter = 'O';
                confidence = 0.6;
            } else if (!thumb && index && middle && !ring && !pinky) {
                letter = 'V'; // ãƒãƒ§ã‚­
            } else if (!thumb && index && middle && ring && !pinky) {
                letter = 'W'; // 3æœ¬
            } else if (thumb && !index && !middle && !ring && pinky) {
                letter = 'Y'; // Shaka
            }

            return { letter, confidence };
        }

        function updateDisplay(result) {
            // æ¤œå‡ºå±¥æ­´ã‚’æ›´æ–°
            detectionHistory.push(result.letter);
            if (detectionHistory.length > 10) detectionHistory.shift();

            // æœ€ã‚‚å¤šãæ¤œå‡ºã•ã‚ŒãŸæ–‡å­—ã‚’ç¢ºå®š
            const counts = {};
            detectionHistory.forEach(l => {
                if (l) counts[l] = (counts[l] || 0) + 1;
            });

            let mostFrequent = null;
            let maxCount = 0;
            for (let l in counts) {
                if (counts[l] > maxCount) {
                    maxCount = counts[l];
                    mostFrequent = l;
                }
            }

            // è¡¨ç¤ºæ›´æ–°
            if (mostFrequent && maxCount >= 5) {
                detectedLetter.textContent = mostFrequent;
                confidenceDiv.textContent = `ç¢ºä¿¡åº¦: ${(result.confidence * 100).toFixed(0)}%`;

                // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                document.querySelectorAll('.letter-btn').forEach(btn => btn.classList.remove('detected'));
                const btn = document.getElementById(`letter-${mostFrequent}`);
                if (btn) btn.classList.add('detected');

                // æ–‡å­—ã‚’è¿½åŠ ï¼ˆåŒã˜æ–‡å­—ã¯é€£ç¶šã§è¿½åŠ ã—ãªã„ï¼‰
                if (mostFrequent !== lastLetter) {
                    letterHoldTime++;
                    if (letterHoldTime > 15) {
                        sentence += mostFrequent;
                        sentenceDiv.textContent = sentence;
                        lastLetter = mostFrequent;
                        letterHoldTime = 0;
                        detectionHistory = [];
                    }
                }
            } else {
                detectedLetter.textContent = '?';
                confidenceDiv.textContent = 'ç¢ºä¿¡åº¦: -';
                document.querySelectorAll('.letter-btn').forEach(btn => btn.classList.remove('detected'));
                letterHoldTime = 0;
            }
        }

        function addSpace() {
            sentence += ' ';
            sentenceDiv.textContent = sentence;
            lastLetter = null;
        }

        function clearSentence() {
            sentence = '';
            sentenceDiv.textContent = '';
            lastLetter = null;
        }

        function draw() {
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            if (hands.length > 0) {
                const hand = hands[0];

                // éª¨æ ¼ã‚’æç”»
                const connections = [
                    [0, 1, 2, 3, 4],
                    [0, 5, 6, 7, 8],
                    [0, 9, 10, 11, 12],
                    [0, 13, 14, 15, 16],
                    [0, 17, 18, 19, 20]
                ];

                ctx.strokeStyle = '#58a6ff';
                ctx.lineWidth = 3;

                for (let finger of connections) {
                    ctx.beginPath();
                    for (let i = 0; i < finger.length; i++) {
                        const kp = hand.keypoints[finger[i]];
                        const x = canvas.width - kp.x;
                        if (i === 0) ctx.moveTo(x, kp.y);
                        else ctx.lineTo(x, kp.y);
                    }
                    ctx.stroke();
                }

                // ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
                for (let i = 0; i < hand.keypoints.length; i++) {
                    const kp = hand.keypoints[i];
                    const isTip = [4, 8, 12, 16, 20].includes(i);

                    ctx.beginPath();
                    ctx.arc(canvas.width - kp.x, kp.y, isTip ? 10 : 5, 0, 2 * Math.PI);
                    ctx.fillStyle = isTip ? '#f85149' : '#4ecca3';
                    ctx.fill();
                }

                // æŒ‡ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                const fingers = getFingerStates(hand);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`è¦ª: ${fingers.thumb ? 'é–‹' : 'é–‰'}`, 10, 30);
                ctx.fillText(`äºº: ${fingers.index ? 'é–‹' : 'é–‰'}`, 10, 50);
                ctx.fillText(`ä¸­: ${fingers.middle ? 'é–‹' : 'é–‰'}`, 10, 70);
                ctx.fillText(`è–¬: ${fingers.ring ? 'é–‹' : 'é–‰'}`, 10, 90);
                ctx.fillText(`å°: ${fingers.pinky ? 'é–‹' : 'é–‰'}`, 10, 110);
            }
        }

        setup();
    </script>
</body>
</html>
