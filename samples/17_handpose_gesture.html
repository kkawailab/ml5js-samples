<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17 - HandPose ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼èªè­˜</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #2c3e50; color: white; }
        .container { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        canvas { border-radius: 15px; }
        .gesture-panel { background: #34495e; padding: 25px; border-radius: 15px; min-width: 250px; }
        .gesture { font-size: 72px; margin: 20px 0; }
        .gesture-name { font-size: 28px; font-weight: bold; color: #3498db; }
        .gesture-list { text-align: left; margin-top: 20px; }
        .gesture-item { padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
        .gesture-item.active { background: #3498db; }
        .gesture-emoji { font-size: 30px; }
        #status { margin-top: 15px; color: #95a5a6; }
    </style>
</head>
<body>
    <h1>ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼èªè­˜</h1>
    <p>æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’èªè­˜ã—ã¾ã™</p>

    <div class="container">
        <canvas id="canvas"></canvas>

        <div class="gesture-panel">
            <div class="gesture" id="gestureEmoji">âœ‹</div>
            <div class="gesture-name" id="gestureName">ãƒ‘ãƒ¼</div>

            <div class="gesture-list">
                <div class="gesture-item" data-gesture="rock">
                    <span class="gesture-emoji">âœŠ</span>
                    <span>ã‚°ãƒ¼</span>
                </div>
                <div class="gesture-item" data-gesture="scissors">
                    <span class="gesture-emoji">âœŒï¸</span>
                    <span>ãƒãƒ§ã‚­</span>
                </div>
                <div class="gesture-item" data-gesture="paper">
                    <span class="gesture-emoji">âœ‹</span>
                    <span>ãƒ‘ãƒ¼</span>
                </div>
                <div class="gesture-item" data-gesture="thumbsup">
                    <span class="gesture-emoji">ğŸ‘</span>
                    <span>ã„ã„ã­</span>
                </div>
                <div class="gesture-item" data-gesture="pointing">
                    <span class="gesture-emoji">ğŸ‘†</span>
                    <span>æŒ‡å·®ã—</span>
                </div>
            </div>

            <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gestureEmoji = document.getElementById('gestureEmoji');
        const gestureName = document.getElementById('gestureName');
        const status = document.getElementById('status');
        const gestureItems = document.querySelectorAll('.gesture-item');

        canvas.width = 640;
        canvas.height = 480;

        let video;
        let handPose;
        let hands = [];

        const gestures = {
            rock: { emoji: 'âœŠ', name: 'ã‚°ãƒ¼' },
            scissors: { emoji: 'âœŒï¸', name: 'ãƒãƒ§ã‚­' },
            paper: { emoji: 'âœ‹', name: 'ãƒ‘ãƒ¼' },
            thumbsup: { emoji: 'ğŸ‘', name: 'ã„ã„ã­' },
            pointing: { emoji: 'ğŸ‘†', name: 'æŒ‡å·®ã—' },
            unknown: { emoji: 'â“', name: 'ä¸æ˜' }
        };

        async function setup() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();

            handPose = await ml5.handPose();
            status.textContent = 'æº–å‚™å®Œäº†ï¼æ‰‹ã‚’ã‹ã–ã—ã¦ãã ã•ã„';

            detectHands();
        }

        async function detectHands() {
            hands = await handPose.detect(video);
            const gesture = recognizeGesture();
            updateDisplay(gesture);
            draw();
            requestAnimationFrame(detectHands);
        }

        function isFingerExtended(hand, tipIndex, pipIndex) {
            const tip = hand.keypoints[tipIndex];
            const pip = hand.keypoints[pipIndex];
            const mcp = hand.keypoints[pipIndex - 1];

            // æŒ‡å…ˆãŒPIPã‚ˆã‚Šä¸Šï¼ˆYåº§æ¨™ãŒå°ã•ã„ï¼‰ãªã‚‰ä¼¸ã³ã¦ã„ã‚‹
            return tip.y < pip.y - 20;
        }

        function isThumbExtended(hand) {
            const tip = hand.keypoints[4];
            const ip = hand.keypoints[3];
            const mcp = hand.keypoints[2];

            // è¦ªæŒ‡ã¯æ¨ªæ–¹å‘ã®ä¼¸ã³ã‚’ãƒã‚§ãƒƒã‚¯
            const dist = Math.abs(tip.x - mcp.x);
            return dist > 40;
        }

        function recognizeGesture() {
            if (hands.length === 0) return 'unknown';

            const hand = hands[0];

            const thumb = isThumbExtended(hand);
            const index = isFingerExtended(hand, 8, 6);
            const middle = isFingerExtended(hand, 12, 10);
            const ring = isFingerExtended(hand, 16, 14);
            const pinky = isFingerExtended(hand, 20, 18);

            // ã‚°ãƒ¼: ã™ã¹ã¦ã®æŒ‡ãŒé–‰ã˜ã¦ã„ã‚‹
            if (!thumb && !index && !middle && !ring && !pinky) {
                return 'rock';
            }

            // ãƒ‘ãƒ¼: ã™ã¹ã¦ã®æŒ‡ãŒé–‹ã„ã¦ã„ã‚‹
            if (index && middle && ring && pinky) {
                return 'paper';
            }

            // ãƒãƒ§ã‚­: äººå·®ã—æŒ‡ã¨ä¸­æŒ‡ã ã‘é–‹ã„ã¦ã„ã‚‹
            if (index && middle && !ring && !pinky) {
                return 'scissors';
            }

            // ã„ã„ã­: è¦ªæŒ‡ã ã‘ç«‹ã£ã¦ã„ã‚‹
            if (thumb && !index && !middle && !ring && !pinky) {
                return 'thumbsup';
            }

            // æŒ‡å·®ã—: äººå·®ã—æŒ‡ã ã‘ç«‹ã£ã¦ã„ã‚‹
            if (!thumb && index && !middle && !ring && !pinky) {
                return 'pointing';
            }

            return 'unknown';
        }

        function updateDisplay(gesture) {
            const g = gestures[gesture];
            gestureEmoji.textContent = g.emoji;
            gestureName.textContent = g.name;

            gestureItems.forEach(item => {
                if (item.dataset.gesture === gesture) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function draw() {
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            if (hands.length > 0) {
                const hand = hands[0];

                // éª¨æ ¼ã‚’æç”»
                const fingerConnections = [
                    [0, 1, 2, 3, 4],
                    [0, 5, 6, 7, 8],
                    [0, 9, 10, 11, 12],
                    [0, 13, 14, 15, 16],
                    [0, 17, 18, 19, 20]
                ];

                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;

                for (let finger of fingerConnections) {
                    ctx.beginPath();
                    for (let i = 0; i < finger.length; i++) {
                        const kp = hand.keypoints[finger[i]];
                        const x = canvas.width - kp.x;
                        if (i === 0) ctx.moveTo(x, kp.y);
                        else ctx.lineTo(x, kp.y);
                    }
                    ctx.stroke();
                }

                // ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’æç”»
                for (let i = 0; i < hand.keypoints.length; i++) {
                    const kp = hand.keypoints[i];
                    const x = canvas.width - kp.x;
                    const isTip = [4, 8, 12, 16, 20].includes(i);

                    ctx.beginPath();
                    ctx.arc(x, kp.y, isTip ? 10 : 5, 0, 2 * Math.PI);
                    ctx.fillStyle = isTip ? '#e74c3c' : '#f39c12';
                    ctx.fill();
                }
            }
        }

        setup();
    </script>
</body>
</html>
