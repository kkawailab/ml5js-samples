<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24 - FaceMesh é ­ã®å‘ãæ¨å®š</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0a0a0a; color: white; text-align: center; }
        .container { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
        canvas { border-radius: 15px; }

        .panel { background: #1a1a1a; padding: 25px; border-radius: 15px; min-width: 280px; }
        .panel h3 { margin-top: 0; color: #58a6ff; }

        .axis-display { display: flex; justify-content: space-around; margin: 20px 0; }
        .axis { text-align: center; }
        .axis-value { font-size: 32px; font-weight: bold; }
        .axis-label { font-size: 12px; color: #888; margin-top: 5px; }

        .head-3d { width: 200px; height: 200px; margin: 20px auto; perspective: 500px; }
        .head-cube { width: 100px; height: 100px; margin: 50px auto; position: relative; transform-style: preserve-3d; transition: transform 0.1s; }
        .cube-face { position: absolute; width: 100px; height: 100px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; font-size: 40px; background: rgba(102, 126, 234, 0.3); }
        .front { transform: translateZ(50px); }
        .back { transform: rotateY(180deg) translateZ(50px); }
        .right { transform: rotateY(90deg) translateZ(50px); }
        .left { transform: rotateY(-90deg) translateZ(50px); }
        .top { transform: rotateX(90deg) translateZ(50px); }
        .bottom { transform: rotateX(-90deg) translateZ(50px); }

        .direction-indicator { margin: 20px 0; padding: 15px; background: #21262d; border-radius: 10px; }
        .direction-text { font-size: 24px; font-weight: bold; }
        .direction-emoji { font-size: 48px; }

        #status { color: #4ecca3; margin: 10px 0; }

        .meter { height: 10px; background: #333; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .meter-fill { height: 100%; transition: width 0.1s, background 0.1s; }
    </style>
</head>
<body>
    <h1>é ­ã®å‘ãæ¨å®š</h1>
    <p>é¡”ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰é ­ã®å›è»¢è§’åº¦ã‚’æ¨å®šã—ã¾ã™</p>

    <div class="container">
        <canvas id="canvas" width="640" height="480"></canvas>

        <div class="panel">
            <h3>å›è»¢è§’åº¦</h3>

            <div class="axis-display">
                <div class="axis">
                    <div class="axis-value" id="yawValue" style="color: #ff6b6b">0Â°</div>
                    <div class="axis-label">Yaw (å·¦å³)</div>
                </div>
                <div class="axis">
                    <div class="axis-value" id="pitchValue" style="color: #4ecdc4">0Â°</div>
                    <div class="axis-label">Pitch (ä¸Šä¸‹)</div>
                </div>
                <div class="axis">
                    <div class="axis-value" id="rollValue" style="color: #f9ca24">0Â°</div>
                    <div class="axis-label">Roll (å‚¾ã)</div>
                </div>
            </div>

            <div class="head-3d">
                <div class="head-cube" id="headCube">
                    <div class="cube-face front">ğŸ˜Š</div>
                    <div class="cube-face back">ğŸ”™</div>
                    <div class="cube-face right">â†’</div>
                    <div class="cube-face left">â†</div>
                    <div class="cube-face top">â†‘</div>
                    <div class="cube-face bottom">â†“</div>
                </div>
            </div>

            <div class="direction-indicator">
                <div class="direction-emoji" id="directionEmoji">ğŸ˜Š</div>
                <div class="direction-text" id="directionText">æ­£é¢</div>
            </div>

            <h3>æ³¨è¦–åº¦</h3>
            <div style="text-align: left;">
                <div>ç”»é¢æ³¨è¦–åº¦</div>
                <div class="meter">
                    <div class="meter-fill" id="attentionMeter" style="width: 0%; background: #4ecca3;"></div>
                </div>
            </div>

            <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const yawValue = document.getElementById('yawValue');
        const pitchValue = document.getElementById('pitchValue');
        const rollValue = document.getElementById('rollValue');
        const headCube = document.getElementById('headCube');
        const directionEmoji = document.getElementById('directionEmoji');
        const directionText = document.getElementById('directionText');
        const attentionMeter = document.getElementById('attentionMeter');
        const status = document.getElementById('status');

        let video;
        let faceMesh;
        let faces = [];

        // é‡è¦ãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        const landmarks = {
            nose: 1,
            leftEye: 33,
            rightEye: 263,
            leftMouth: 61,
            rightMouth: 291,
            chin: 152,
            forehead: 10,
            leftCheek: 234,
            rightCheek: 454
        };

        async function setup() {
            video = document.createElement('video');
            video.width = 640;
            video.height = 480;

            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();

            faceMesh = await ml5.faceMesh();
            status.textContent = 'æº–å‚™å®Œäº†ï¼';

            detectFaces();
        }

        async function detectFaces() {
            faces = await faceMesh.detect(video);
            analyzeHeadPose();
            draw();
            requestAnimationFrame(detectFaces);
        }

        function getPoint(index) {
            if (faces.length === 0) return null;
            const kp = faces[0].keypoints[index];
            return { x: kp.x, y: kp.y, z: kp.z || 0 };
        }

        function analyzeHeadPose() {
            if (faces.length === 0) {
                directionText.textContent = 'é¡”ã‚’æ¤œå‡ºä¸­...';
                directionEmoji.textContent = 'â“';
                return;
            }

            const nose = getPoint(landmarks.nose);
            const leftEye = getPoint(landmarks.leftEye);
            const rightEye = getPoint(landmarks.rightEye);
            const leftMouth = getPoint(landmarks.leftMouth);
            const rightMouth = getPoint(landmarks.rightMouth);
            const chin = getPoint(landmarks.chin);
            const forehead = getPoint(landmarks.forehead);

            if (!nose || !leftEye || !rightEye) return;

            // Yaw (å·¦å³ã®å›è»¢) - ç›®ã®é–“ã®ä¸­å¿ƒã¨é¼»ã®ä½ç½®ã®å·®
            const eyeCenter = { x: (leftEye.x + rightEye.x) / 2, y: (leftEye.y + rightEye.y) / 2 };
            const eyeDistance = Math.abs(rightEye.x - leftEye.x);
            const yaw = ((nose.x - eyeCenter.x) / eyeDistance) * 60;

            // Pitch (ä¸Šä¸‹ã®å›è»¢) - é¼»ã¨ç›®ã®ä¸­å¿ƒã€é¡ã®ä½ç½®é–¢ä¿‚
            const faceHeight = chin.y - forehead.y;
            const noseRatio = (nose.y - forehead.y) / faceHeight;
            const pitch = (noseRatio - 0.45) * 100;

            // Roll (å‚¾ã) - ç›®ã®å‚¾ã
            const roll = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x) * (180 / Math.PI);

            // å€¤ã‚’æ›´æ–°
            yawValue.textContent = `${yaw.toFixed(0)}Â°`;
            pitchValue.textContent = `${pitch.toFixed(0)}Â°`;
            rollValue.textContent = `${roll.toFixed(0)}Â°`;

            // 3Dã‚­ãƒ¥ãƒ¼ãƒ–ã‚’å›è»¢
            headCube.style.transform = `rotateY(${-yaw}deg) rotateX(${pitch}deg) rotateZ(${roll}deg)`;

            // å‘ãã®åˆ¤å®š
            let direction = 'æ­£é¢';
            let emoji = 'ğŸ˜Š';

            if (Math.abs(yaw) > 15 || Math.abs(pitch) > 15) {
                if (yaw < -15) { direction = 'å³ã‚’å‘ã„ã¦ã„ã‚‹'; emoji = 'ğŸ‘‰'; }
                else if (yaw > 15) { direction = 'å·¦ã‚’å‘ã„ã¦ã„ã‚‹'; emoji = 'ğŸ‘ˆ'; }
                else if (pitch < -15) { direction = 'ä¸Šã‚’å‘ã„ã¦ã„ã‚‹'; emoji = 'ğŸ‘†'; }
                else if (pitch > 15) { direction = 'ä¸‹ã‚’å‘ã„ã¦ã„ã‚‹'; emoji = 'ğŸ‘‡'; }
            }

            directionText.textContent = direction;
            directionEmoji.textContent = emoji;

            // æ³¨è¦–åº¦ï¼ˆæ­£é¢ã‚’å‘ã„ã¦ã„ã‚‹ã»ã©é«˜ã„ï¼‰
            const attention = Math.max(0, 100 - Math.abs(yaw) * 2 - Math.abs(pitch) * 2);
            attentionMeter.style.width = `${attention}%`;
            attentionMeter.style.background = attention > 70 ? '#4ecca3' : attention > 40 ? '#f39c12' : '#e74c3c';
        }

        function draw() {
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            if (faces.length > 0) {
                const face = faces[0];

                // é¡”ã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚’æç”»
                ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                for (let kp of face.keypoints) {
                    ctx.beginPath();
                    ctx.arc(canvas.width - kp.x, kp.y, 1, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿
                const importantPoints = [
                    landmarks.nose,
                    landmarks.leftEye,
                    landmarks.rightEye,
                    landmarks.chin,
                    landmarks.forehead
                ];

                ctx.fillStyle = '#ff6b6b';
                for (let idx of importantPoints) {
                    const kp = face.keypoints[idx];
                    ctx.beginPath();
                    ctx.arc(canvas.width - kp.x, kp.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // é¡”ã®è»¸ã‚’æç”»
                const nose = getPoint(landmarks.nose);
                const forehead = getPoint(landmarks.forehead);
                const chin = getPoint(landmarks.chin);

                // ç¸¦è»¸
                ctx.strokeStyle = '#4ecdc4';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(canvas.width - forehead.x, forehead.y);
                ctx.lineTo(canvas.width - chin.x, chin.y);
                ctx.stroke();

                // æ¨ªè»¸ï¼ˆç›®ï¼‰
                const leftEye = getPoint(landmarks.leftEye);
                const rightEye = getPoint(landmarks.rightEye);
                ctx.strokeStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.moveTo(canvas.width - leftEye.x, leftEye.y);
                ctx.lineTo(canvas.width - rightEye.x, rightEye.y);
                ctx.stroke();
            }
        }

        setup();
    </script>
</body>
</html>
