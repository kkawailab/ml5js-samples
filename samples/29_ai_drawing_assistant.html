<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>29 - AI ãŠçµµã‹ãã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #1a1a2e; color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #667eea; }
        .main { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 900px) { .main { grid-template-columns: 1fr; } }

        .canvas-area { position: relative; }
        #drawCanvas { background: white; border-radius: 15px; cursor: crosshair; display: block; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn { padding: 10px 15px; border: 2px solid #333; border-radius: 8px; background: #16213e; color: white; cursor: pointer; transition: all 0.3s; }
        .tool-btn:hover { border-color: #667eea; }
        .tool-btn.active { background: #667eea; border-color: #667eea; }
        .color-picker { display: flex; gap: 5px; align-items: center; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .color-btn.active { border-color: white; transform: scale(1.2); }
        input[type="range"] { width: 100px; }

        .panel { background: #16213e; padding: 20px; border-radius: 15px; }
        .panel h3 { margin-top: 0; color: #667eea; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .prediction-box { background: #0f3460; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .prediction-text { font-size: 24px; font-weight: bold; color: #4ecca3; }
        .confidence-text { font-size: 14px; color: #888; margin-top: 5px; }

        .suggestions { margin-bottom: 20px; }
        .suggestion-item { padding: 10px; background: #0f3460; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-bar { width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .suggestion-fill { height: 100%; background: #667eea; }

        .actions button { width: 100%; padding: 12px; margin-bottom: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .clear-btn { background: #e74c3c; color: white; }
        .save-btn { background: #27ae60; color: white; }

        #status { text-align: center; color: #4ecca3; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ AI ãŠçµµã‹ãã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p style="text-align: center;">æã„ã¦ã„ã‚‹é€”ä¸­ã§AIãŒä½•ã‚’æã„ã¦ã„ã‚‹ã‹äºˆæ¸¬ã—ã¾ã™</p>

        <div class="main">
            <div class="canvas-area">
                <div class="toolbar">
                    <div class="color-picker">
                        <button class="color-btn active" style="background: #000" data-color="#000000"></button>
                        <button class="color-btn" style="background: #e74c3c" data-color="#e74c3c"></button>
                        <button class="color-btn" style="background: #3498db" data-color="#3498db"></button>
                        <button class="color-btn" style="background: #27ae60" data-color="#27ae60"></button>
                        <button class="color-btn" style="background: #f39c12" data-color="#f39c12"></button>
                        <button class="color-btn" style="background: #9b59b6" data-color="#9b59b6"></button>
                    </div>
                    <div>
                        <label>å¤ªã•: </label>
                        <input type="range" id="brushSize" min="2" max="30" value="8">
                    </div>
                    <button class="tool-btn active" data-tool="brush">ğŸ–Œï¸ ãƒ–ãƒ©ã‚·</button>
                    <button class="tool-btn" data-tool="eraser">ğŸ§¹ æ¶ˆã—ã‚´ãƒ </button>
                </div>
                <canvas id="drawCanvas" width="640" height="480"></canvas>
                <div id="status">æãå§‹ã‚ã‚‹ã¨AIãŒäºˆæ¸¬ã—ã¾ã™</div>
            </div>

            <div class="panel">
                <h3>ğŸ¤– AIäºˆæ¸¬</h3>
                <div class="prediction-box">
                    <div class="prediction-text" id="topPrediction">?</div>
                    <div class="confidence-text" id="topConfidence">æã„ã¦ãã ã•ã„</div>
                </div>

                <div class="suggestions">
                    <h3>äºˆæ¸¬å€™è£œ</h3>
                    <div id="suggestionList">
                        <p style="color: #888; text-align: center;">æãå§‹ã‚ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>

                <div class="actions">
                    <button class="clear-btn" onclick="clearCanvas()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                    <button class="save-btn" onclick="saveDrawing()">ğŸ’¾ ä¿å­˜</button>
                </div>

                <div class="panel" style="margin-top: 20px; padding: 15px;">
                    <h3 style="font-size: 14px;">ãƒ’ãƒ³ãƒˆ</h3>
                    <p style="font-size: 12px; color: #888; margin: 0;">
                        ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã‚’æãã¨èªè­˜ã•ã‚Œã‚„ã™ã„ã§ã™ã€‚<br>
                        ä¾‹: çŒ«ã€çŠ¬ã€è»Šã€å®¶ã€èŠ±ã€å¤ªé™½ãªã©
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        const topPrediction = document.getElementById('topPrediction');
        const topConfidence = document.getElementById('topConfidence');
        const suggestionList = document.getElementById('suggestionList');
        const status = document.getElementById('status');
        const brushSize = document.getElementById('brushSize');
        const colorBtns = document.querySelectorAll('.color-btn');
        const toolBtns = document.querySelectorAll('.tool-btn');

        let classifier;
        let isDrawing = false;
        let currentColor = '#000000';
        let currentTool = 'brush';
        let lastX = 0;
        let lastY = 0;
        let strokeCount = 0;

        // è‰²é¸æŠ
        colorBtns.forEach(btn => {
            btn.onclick = () => {
                colorBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentColor = btn.dataset.color;
            };
        });

        // ãƒ„ãƒ¼ãƒ«é¸æŠ
        toolBtns.forEach(btn => {
            btn.onclick = () => {
                toolBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
            };
        });

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç™½ã§åˆæœŸåŒ–
        function initCanvas() {
            drawCtx.fillStyle = 'white';
            drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
        }
        initCanvas();

        // æç”»ã‚¤ãƒ™ãƒ³ãƒˆ
        drawCanvas.onmousedown = (e) => {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        };

        drawCanvas.onmousemove = (e) => {
            if (!isDrawing) return;

            drawCtx.beginPath();
            drawCtx.moveTo(lastX, lastY);
            drawCtx.lineTo(e.offsetX, e.offsetY);

            if (currentTool === 'eraser') {
                drawCtx.strokeStyle = 'white';
                drawCtx.lineWidth = brushSize.value * 3;
            } else {
                drawCtx.strokeStyle = currentColor;
                drawCtx.lineWidth = brushSize.value;
            }

            drawCtx.lineCap = 'round';
            drawCtx.stroke();

            [lastX, lastY] = [e.offsetX, e.offsetY];
        };

        drawCanvas.onmouseup = () => {
            if (isDrawing) {
                isDrawing = false;
                strokeCount++;
                classifyDrawing();
            }
        };

        drawCanvas.onmouseleave = () => {
            if (isDrawing) {
                isDrawing = false;
                strokeCount++;
                classifyDrawing();
            }
        };

        // ã‚¿ãƒƒãƒå¯¾å¿œ
        drawCanvas.ontouchstart = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = drawCanvas.getBoundingClientRect();
            isDrawing = true;
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        };

        drawCanvas.ontouchmove = (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = drawCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            drawCtx.beginPath();
            drawCtx.moveTo(lastX, lastY);
            drawCtx.lineTo(x, y);
            drawCtx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
            drawCtx.lineWidth = currentTool === 'eraser' ? brushSize.value * 3 : brushSize.value;
            drawCtx.lineCap = 'round';
            drawCtx.stroke();

            lastX = x;
            lastY = y;
        };

        drawCanvas.ontouchend = () => {
            if (isDrawing) {
                isDrawing = false;
                strokeCount++;
                classifyDrawing();
            }
        };

        // åˆ†é¡å™¨ã‚’åˆæœŸåŒ–
        async function initClassifier() {
            status.textContent = 'AIã‚’èª­ã¿è¾¼ã¿ä¸­...';
            classifier = await ml5.imageClassifier('MobileNet');
            status.textContent = 'æº–å‚™å®Œäº†ï¼æãå§‹ã‚ã¦ãã ã•ã„';
        }

        // æç”»ã‚’åˆ†é¡
        async function classifyDrawing() {
            if (!classifier) return;
            if (strokeCount < 2) {
                status.textContent = 'ã‚‚ã†å°‘ã—æã„ã¦ãã ã•ã„...';
                return;
            }

            status.textContent = 'åˆ†æä¸­...';

            try {
                const results = await classifier.classify(drawCanvas, 5);
                displayResults(results);
            } catch (error) {
                status.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
        }

        function displayResults(results) {
            if (!results || results.length === 0) {
                status.textContent = 'èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ';
                return;
            }

            // ãƒˆãƒƒãƒ—äºˆæ¸¬
            const top = results[0];
            const label = top.label.split(',')[0];
            topPrediction.textContent = label;
            topConfidence.textContent = `ç¢ºä¿¡åº¦: ${(top.confidence * 100).toFixed(1)}%`;

            // å€™è£œãƒªã‚¹ãƒˆ
            suggestionList.innerHTML = results.slice(0, 5).map(r => {
                const label = r.label.split(',')[0];
                const confidence = (r.confidence * 100).toFixed(1);
                return `
                    <div class="suggestion-item">
                        <span>${label}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="suggestion-bar">
                                <div class="suggestion-fill" style="width: ${confidence}%"></div>
                            </div>
                            <span style="font-size: 12px; color: #888;">${confidence}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            status.textContent = `ã€Œ${label}ã€ã«è¦‹ãˆã¾ã™`;
        }

        function clearCanvas() {
            initCanvas();
            strokeCount = 0;
            topPrediction.textContent = '?';
            topConfidence.textContent = 'æã„ã¦ãã ã•ã„';
            suggestionList.innerHTML = '<p style="color: #888; text-align: center;">æãå§‹ã‚ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
            status.textContent = 'æãå§‹ã‚ã‚‹ã¨AIãŒäºˆæ¸¬ã—ã¾ã™';
        }

        function saveDrawing() {
            const link = document.createElement('a');
            link.download = 'my-drawing.png';
            link.href = drawCanvas.toDataURL();
            link.click();
        }

        // åˆæœŸåŒ–
        initClassifier();
    </script>
</body>
</html>
